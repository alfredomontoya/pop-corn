import{r as h,b as y,j as e}from"./app-BptPjD3z.js";import{B as j}from"./button-YlEUOrkT.js";import{T as w}from"./trash-MWrAd4nW.js";function E(o){const[d,l]=h.useState(o);return{form:d,setData:(s,a)=>{l(t=>({...t,[s]:a}))},addDetalle:s=>{l(a=>({...a,detalles:[...a.detalles,s]}))},updateDetalle:(s,a)=>{l(t=>{const n=[...t.detalles];return n[s]=a,{...t,detalles:n}})},removeDetalle:s=>{l(a=>{const t=[...a.detalles];return t.splice(s,1),{...a,detalles:t}})},resetForm:()=>l(o)}}const _=({form:o,setData:d,defaultCliente:l})=>{const[x,b]=h.useState(""),[r,p]=h.useState([]),[i,s]=h.useState(0),[a,t]=h.useState(!1),[n,m]=h.useState(!1),f=h.useRef(null);h.useEffect(()=>{l&&!n&&(d("cliente_id",String(l.id)),b(`${l.nombre_razon_social} - ${l.propietario}`),m(!0))},[l,n,d]),h.useEffect(()=>{const c=u=>{f.current&&!f.current.contains(u.target)&&t(!1)};return document.addEventListener("mousedown",c),()=>document.removeEventListener("mousedown",c)},[]),h.useEffect(()=>{if(x.length<2||n){p([]),t(!1);return}const c=setTimeout(async()=>{try{const u=await y.get(`/clientes/search?search=${x}`);Array.isArray(u.data?.data)?(p(u.data.data),t(!0),s(0)):(p([]),t(!1))}catch(u){console.error(u),p([]),t(!1)}},300);return()=>clearTimeout(c)},[x,n]);const N=c=>{d("cliente_id",String(c.id)),b(`${c.nombre_razon_social} - ${c.propietario}`),t(!1),p([]),m(!0)},v=c=>{a&&(c.key==="ArrowDown"?(c.preventDefault(),s(u=>(u+1)%r.length)):c.key==="ArrowUp"?(c.preventDefault(),s(u=>(u-1+r.length)%r.length)):c.key==="Enter"&&(c.preventDefault(),r[i]&&N(r[i])))},g=c=>{b(c),m(!1)};return e.jsxs("div",{className:"relative",ref:f,children:[e.jsx("input",{type:"text",placeholder:"Buscar cliente...",value:x,onChange:c=>g(c.target.value),onKeyDown:v,className:"border p-2 w-full"}),a&&r.length>0&&e.jsx("ul",{className:"absolute top-full left-0 w-full bg-white border max-h-40 overflow-y-auto z-10",children:r.map((c,u)=>e.jsxs("li",{className:`p-2 cursor-pointer ${u===i?"bg-blue-500 text-white":""}`,onMouseEnter:()=>s(u),onClick:()=>N(c),children:[c.nombre_razon_social," - ",c.propietario]},c.id))})]})},S=({detalles:o,productos:d,addDetalle:l,updateDetalle:x,removeDetalle:b,errors:r={}})=>{const p=(s,a)=>{const t=d.find(f=>String(f.id)===a),n=t?Number(t.precio_activo?.precio_venta??0):0,m=o[s].cantidad;x(s,{...o[s],producto_id:a,precio:n,subtotal:Number(m)*n})},i=(s,a)=>{const t=o[s].precio;x(s,{...o[s],cantidad:a,subtotal:Number(a)*Number(t)})};return e.jsxs("div",{className:"mt-4 mb-4",children:[e.jsx("label",{className:"block font-bold mb-2",children:"Detalles"}),e.jsx("div",{className:"overflow-x-auto bg-default rounded-lg shadow",children:e.jsxs("table",{className:"min-w-full border border-gray-300",children:[e.jsx("thead",{className:"",children:e.jsxs("tr",{children:[e.jsx("th",{className:"border px-2 py-1",children:"Producto"}),e.jsx("th",{className:"border px-2 py-1",children:"Cantidad"}),e.jsx("th",{className:"border px-2 py-1",children:"Precio"}),e.jsx("th",{className:"border px-2 py-1",children:"Total"}),e.jsx("th",{className:"border px-2 py-1",children:"Acciones"})]})}),e.jsx("tbody",{children:o.map((s,a)=>e.jsxs("tr",{children:[e.jsxs("td",{className:"border px-2 py-1",children:[e.jsxs("select",{value:s.producto_id,onChange:t=>p(a,t.target.value),className:"border p-1 w-full",children:[e.jsx("option",{value:"",children:"Seleccione..."}),d.map(t=>e.jsx("option",{value:String(t.id),children:t.nombre},t.id))]}),r[`detalles.${a}.producto_id`]&&e.jsx("p",{className:"text-red-500 text-sm",children:r[`detalles.${a}.producto_id`][0]})]}),e.jsxs("td",{className:"border px-2 py-1",children:[e.jsx("input",{type:"text",value:s.cantidad,onChange:t=>i(a,t.target.value),className:"border p-1 w-full"}),r[`detalles.${a}.cantidad`]&&e.jsx("p",{className:"text-red-500 text-sm",children:r[`detalles.${a}.cantidad`][0]})]}),e.jsxs("td",{className:"border px-2 py-1 text-right",children:[s.precio.toFixed(2),r[`detalles.${a}.precio`]&&e.jsx("p",{className:"text-red-500 text-sm",children:r[`detalles.${a}.precio`][0]})]}),e.jsxs("td",{className:"border px-2 py-1 text-right",children:[(s.subtotal??Number(s.cantidad)*Number(s.precio)).toFixed(2),r[`detalles.${a}.subtotal`]&&e.jsx("p",{className:"text-red-500 text-sm",children:r[`detalles.${a}.subtotal`][0]})]}),e.jsx("td",{className:"border px-2 py-1 text-center",children:e.jsx(j,{variant:"destructive",onClick:()=>b(a),children:e.jsx(w,{size:16})})})]},a))})]})}),e.jsx(j,{type:"button",onClick:()=>l({producto_id:"",cantidad:0,precio:0,subtotal:0}),variant:"default",className:"mt-2",children:"Agregar Detalle"})]})},D=({form:o,productos:d,setData:l,addDetalle:x,updateDetalle:b,removeDetalle:r,onSubmit:p,errors:i={},pedido:s})=>{h.useEffect(()=>{s&&(l("cliente_id",String(s.cliente_id)),l("fecha",s.fecha),l("estado",s.estado),l("observacion",s.observacion||""),l("detalles",s.detalles.map(t=>({producto_id:String(t.producto_id),cantidad:t.cantidad,precio:Number(t.precio),subtotal:Number(t.subtotal)}))),l("total",Number(s.total)))},[s?.id]),h.useEffect(()=>{if(!s&&o.detalles.length===0&&d.length>0){const t=d.slice(0,3).map(n=>{const m=Number(n.precio_activo?.precio_venta??0);return{producto_id:String(n.id),cantidad:"0",precio:m,subtotal:0}});l("detalles",t)}},[s,d]),h.useEffect(()=>{const t=o.detalles?.reduce((n,m)=>n+(m.subtotal??0),0)??0;l("total",t)},[o.detalles]);const a=(t,n)=>{const m=Number(n.cantidad)*Number(n.precio);b(t,{...n,subtotal:m})};return e.jsxs("div",{className:"p-4 space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block font-bold",children:"Cliente"}),e.jsx(_,{form:o,setData:l,defaultCliente:s?.cliente??null}),i.cliente_id&&e.jsx("p",{className:"text-red-500 text-sm",children:i.cliente_id[0]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block font-bold",children:"Fecha"}),e.jsx("input",{type:"date",value:o.fecha,onChange:t=>l("fecha",t.target.value),className:"border p-2 w-full"}),i.fecha&&e.jsx("p",{className:"text-red-500 text-sm",children:i.fecha[0]})]}),e.jsx(S,{detalles:o.detalles,productos:d,addDetalle:t=>{x({...t,subtotal:Number(t.cantidad)*Number(t.precio)})},updateDetalle:a,removeDetalle:r,errors:i}),e.jsxs("div",{className:"text-right",children:[e.jsx("span",{className:"font-bold text-lg",children:"Total: "}),e.jsx("span",{className:"text-2xl text-green-600 font-bold",children:(+o.total||0).toFixed(2)})]}),i.total&&e.jsx("p",{className:"text-red-500 text-sm",children:i.total[0]}),e.jsxs("div",{children:[e.jsx("label",{className:"block font-bold",children:"ObservaciÃ³n"}),e.jsx("textarea",{value:o.observacion,onChange:t=>l("observacion",t.target.value),className:"border p-2 w-full"}),i.observacion&&e.jsx("p",{className:"text-red-500 text-sm",children:i.observacion[0]})]}),e.jsx(j,{type:"button",onClick:p,variant:"default",children:s?"Actualizar":"Guardar"})]})};export{D as P,E as u};
