import{r as x,b as v,j as e}from"./app-CZ5wKpKF.js";import{A as B}from"./app-layout-W9ns13d5.js";import{c as T,b as U,B as m}from"./button-DEkS-519.js";import{D as F,a as _,b as E,c as I,d as k}from"./dialog-1BEMAEhu.js";import{I as V}from"./input-BPblLnNC.js";import{L as q}from"./label-BiHx0aQO.js";import{T as z}from"./TextArea-Bv-Ii64s.js";import{d as M}from"./dayjs.min-B5jtzr9N.js";/* empty css            */import"./Edit-Cdu2FDnW.js";import"./index-BDmOzyiv.js";import"./createLucideIcon-CSAcrkPz.js";import"./index-B-1RjBMx.js";import"./index-BTsKYuKu.js";import"./index-jxqWOHrT.js";import"./app-logo-icon-B8Qs5zSS.js";function S(){const[n,l]=x.useState({data:[]}),[a,s]=x.useState(!1),[h,r]=x.useState({}),[t,j]=x.useState(""),f=async i=>{try{s(!0),console.log("Fetching cajas...");let o="/cajas";const c=new URLSearchParams;i?.fechaInicio&&c.append("fechaInicio",i.fechaInicio),i?.fechaFin&&c.append("fechaFin",i.fechaFin),i?.page&&c.append("page",i.page.toString()),c.toString()&&(o+=`?${c.toString()}`);const{data:d}=await v.get(o);l(d),j(d.fecha||"")}catch(o){console.error("Error al obtener cajas:",o)}finally{s(!1)}};return{cajas:n,loading:a,errors:h,fetchCajas:f,getCaja:async i=>{try{s(!0);const{data:o}=await v.get(`/cajas/${i}`);return o}catch(o){return console.error("Error al obtener caja:",o),r({msg:"No se pudo obtener el detalle de la caja"}),null}finally{s(!1)}},createCaja:async i=>{console.log("Creating caja with values:",i);try{return s(!0),r({}),await v.post("/cajas",i),!0}catch(o){const c=o;if(c.response?.status===422){const d=c.response.data;typeof d.errors=="object"?r(d.errors):d.message&&r({msg:d.message})}else console.error("Error al crear caja:",c),r({msg:"Error inesperado al crear la caja"});return!1}finally{s(!1)}},updateCaja:async(i,o)=>{try{return s(!0),r({}),await v.put(`/cajas/${i}`,o),await f(),!0}catch(c){const d=c;if(d.response?.status===422){const b=d.response.data;typeof b.errors=="object"?r(b.errors):b.message&&r({msg:b.message})}else r({msg:"Error inesperado al actualizar la caja"});return!1}finally{s(!1)}},deleteCaja:async i=>{if(!confirm("¿Seguro que deseas eliminar esta caja?"))return!1;try{return s(!0),await v.delete(`/cajas/${i}`),await f(),!0}catch(c){return console.error("Error al eliminar caja:",c),r({msg:"No se pudo eliminar la caja"}),!1}finally{s(!1)}},cerrarCaja:async i=>{try{s(!0);const{data:o}=await v.post(`/cajas/${i}/cerrar`);return o.success?(l(c=>({...c,data:c.data.map(d=>d.id===i?o.caja:d)})),!0):(r({msg:o.message}),!1)}catch(o){return r({msg:o.response?.data?.message||"Error al cerrar la caja"}),!1}finally{s(!1)}},fecha:t}}const G=U("relative w-full rounded-lg border px-4 py-3 text-sm grid has-[>svg]:grid-cols-[calc(var(--spacing)*4)_1fr] grid-cols-[0_1fr] has-[>svg]:gap-x-3 gap-y-0.5 items-start [&>svg]:size-4 [&>svg]:translate-y-0.5 [&>svg]:text-current",{variants:{variant:{default:"bg-background text-foreground",destructive:"text-destructive-foreground [&>svg]:text-current *:data-[slot=alert-description]:text-destructive-foreground/80"}},defaultVariants:{variant:"default"}});function D({className:n,variant:l,...a}){return e.jsx("div",{"data-slot":"alert",role:"alert",className:T(G({variant:l}),n),...a})}function A({className:n,...l}){return e.jsx("div",{"data-slot":"alert-description",className:T("text-muted-foreground col-start-2 grid justify-items-start gap-1 text-sm [&_p]:leading-relaxed",n),...l})}function J({data:n,setData:l,errors:a,processing:s,onSubmit:h,reset:r}){return e.jsxs("form",{onSubmit:h,className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx(q,{htmlFor:"saldo_inicial",children:"Saldo inicial"}),e.jsx(V,{id:"saldo_inicial",type:"number",step:"0.01",value:n.saldo_inicial??"",onChange:t=>l("saldo_inicial",parseFloat(t.target.value)),className:a.saldo_inicial?"border-red-500":""}),a.saldo_inicial&&e.jsx("p",{className:"text-sm text-red-600 mt-1",children:a.saldo_inicial})]}),e.jsxs("div",{children:[e.jsx(z,{label:"Observacion",value:n.observacion??"",onChange:t=>l("observacion",t),error:a.observacion}),a.observacion&&e.jsx("p",{className:"text-sm text-red-600 mt-1",children:a.observacion})]}),e.jsxs("div",{className:"flex justify-end gap-2 pt-2",children:[e.jsx(m,{type:"button",variant:"outline",onClick:r,disabled:s,children:"Limpiar"}),e.jsx(m,{type:"submit",disabled:s,children:s?"Guardando...":"Guardar"})]})]})}function K({open:n,onClose:l,onSuccess:a}){const{createCaja:s,errors:h,loading:r}=S(),[t,j]=x.useState({saldo_inicial:0,observacion:""}),f=(g,N)=>{j(w=>({...w,[g]:N}))},p=()=>{j({saldo_inicial:0,observacion:""})},C=async g=>{g.preventDefault(),await s(t)&&(p(),a?.(),l())};return e.jsx(F,{open:n,onOpenChange:l,children:e.jsxs(_,{className:"max-w-lg max-h-[90vh] overflow-y-auto",children:[e.jsxs(E,{children:[e.jsx(I,{children:"Aperturar Caja"}),e.jsx(k,{children:"Complete los datos para aperturar una nueva caja."})]}),h.msg&&e.jsx(D,{variant:"destructive",className:"mb-4",children:e.jsx(A,{children:h.msg})}),e.jsx(J,{data:t,setData:f,errors:h,processing:r,onSubmit:C,reset:p})]})})}function Q({open:n,onClose:l,caja:a,onSuccess:s}){const{cerrarCaja:h,errors:r}=S(),[t,j]=x.useState(!1),f=async()=>{if(!a)return;j(!0);const p=await h(a.id);j(!1),p&&(s?.(),l())};return e.jsx(F,{open:n,onOpenChange:l,children:e.jsxs(_,{className:"max-w-md max-h-[80vh] overflow-y-auto",children:[e.jsxs(E,{children:[e.jsx(I,{children:"Cerrar Caja"}),e.jsx(k,{children:a?`¿Estás seguro de cerrar la caja #${a.id} del usuario ${a.user_id}?`:"No se ha seleccionado ninguna caja."})]}),r.msg&&e.jsx(D,{variant:"destructive",className:"mb-4",children:e.jsx(A,{children:r.msg})}),e.jsxs("div",{className:"flex justify-end space-x-2 mt-4",children:[e.jsx(m,{variant:"outline",onClick:l,disabled:t,children:"Cancelar"}),e.jsx(m,{className:"bg-red-500 text-white hover:bg-red-600",onClick:f,disabled:t,children:t?"Cerrando...":"Cerrar Caja"})]})]})})}function W({open:n,onClose:l,caja:a}){const{cerrarCaja:s,errors:h}=S(),[r,t]=x.useState(!1),j=async()=>{if(!a)return;t(!0);const g=await s(a.id);t(!1),g&&l()},f=a?.ingresos_calculados??0,p=a?.egresos_calculados??0,C=a?.saldo_final_calculado??0;return e.jsx(F,{open:n,onOpenChange:l,children:e.jsxs(_,{className:"max-w-md max-h-[80vh] overflow-y-auto",children:[e.jsxs(E,{children:[e.jsxs(I,{children:["Caja #",a?.id]}),e.jsxs(k,{children:["Usuario: ",a?.user?.name||"Desconocido"," ",e.jsx("br",{}),"Estado: ",a?.estado]})]}),h.msg&&e.jsx(D,{variant:"destructive",className:"mb-4",children:e.jsx(A,{children:h.msg})}),a&&e.jsxs("div",{className:"border rounded-lg p-4 bg-gray-50/30 mb-4",children:[e.jsx("h4",{className:"font-semibold mb-2 text-gray-700",children:"Resumen de Caja"}),e.jsxs("div",{className:"flex justify-between text-sm mb-1",children:[e.jsx("span",{children:"Total Ingresos:"}),e.jsxs("span",{className:"font-medium text-green-600",children:["Bs ",f.toFixed(2)]})]}),e.jsxs("div",{className:"flex justify-between text-sm mb-1",children:[e.jsx("span",{children:"Total Egresos:"}),e.jsxs("span",{className:"font-medium text-red-600",children:["Bs ",p.toFixed(2)]})]}),e.jsxs("div",{className:"flex justify-between text-sm border-t pt-2 mt-2",children:[e.jsx("span",{children:"Saldo Final:"}),e.jsxs("span",{className:"font-semibold text-blue-600",children:["Bs ",C.toFixed(2)]})]})]}),e.jsxs("div",{className:"flex justify-end space-x-2 mt-4",children:[e.jsx(m,{variant:"outline",onClick:l,disabled:r,children:"Cerrar"}),a?.estado!=="CERRADA"&&e.jsx(m,{className:"bg-red-500 text-white hover:bg-red-600",onClick:j,disabled:r,children:r?"Cerrando...":"Cerrar Caja"})]})]})})}const X=({cajas:n,loading:l,refreshing:a,onCerrarCaja:s,onShowCaja:h,totales:r})=>(console.log(n),e.jsx("div",{className:"overflow-x-auto bg-default rounded-lg shadow",children:e.jsxs("table",{className:"w-full dark:bg-white/10 table-auto",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"ID"}),e.jsx("th",{children:"Usuario"}),e.jsx("th",{children:"Fecha apertura"}),e.jsx("th",{children:"Fecha cierre"}),e.jsx("th",{children:"Saldo Inicial"}),e.jsx("th",{children:"Total Ingresos"}),e.jsx("th",{children:"Total Egresos"}),e.jsx("th",{children:"Saldo Final"}),e.jsx("th",{children:"Estado"}),e.jsx("th",{children:"Acciones"})]})}),e.jsx("tbody",{children:n.map(t=>e.jsxs("tr",{className:"hover:bg-gray-200 dark:hover:bg-white/20",children:[e.jsx("td",{className:"p-2",children:t.id}),e.jsx("td",{className:"p-2",children:t.user?.name||"Desconocido"}),e.jsx("td",{className:"p-2",children:M(t.fecha_apertura).format("DD/MM/YYYY HH:mm")}),e.jsx("td",{className:"p-2",children:M(t.fecha_cierre).format("DD/MM/YYYY HH:mm")||"Abierta"}),e.jsx("td",{className:"p-2 text-right",children:t.saldo_inicial.toFixed(2)||"N/A"}),e.jsx("td",{className:"p-2 text-right",children:t.total_ingresos.toFixed(2)||"N/A"}),e.jsx("td",{className:"p-2 text-right",children:t.total_egresos.toFixed(2)||"N/A"}),e.jsx("td",{className:"p-2 text-right",children:t.saldo_final?.toFixed(2)||"N/A"}),e.jsx("td",{className:"p-2",children:t.estado}),e.jsxs("td",{className:"p-2 text-center",children:[e.jsx(m,{variant:"default",className:"mb-1 w-20",onClick:()=>h?.(t),children:"Ver"}),e.jsx(m,{variant:"warning",className:"mb-1 w-20",onClick:()=>s(t),children:"Cerrar"})]})]},t.id))}),e.jsx("tfoot",{children:e.jsxs("tr",{children:[e.jsx("td",{colSpan:5,className:"p-2 text-right font-semibold",children:"Totales:"}),e.jsx("td",{className:"p-2 text-right font-semibold",children:r.totalIngresos.toFixed(2)}),e.jsx("td",{className:"p-2 text-right font-semibold",children:r.totalEgresos.toFixed(2)}),e.jsx("td",{className:"p-2 text-right font-semibold",children:r.totalSaldoFinal.toFixed(2)}),e.jsx("td",{className:"p-2 text-center"})]})})]})})),Z=({currentPage:n,lastPage:l,onPageChange:a})=>l<=1?null:e.jsx("div",{className:"flex justify-center mt-4 space-x-2",children:Array.from({length:l},(s,h)=>h+1).map(s=>e.jsx(m,{onClick:()=>a(s),variant:`${s===n?"default":"secondary"}`,className:`${s==n?"":"cursor-pointer"}`,children:s},s))}),fe=()=>{const{cajas:n,loading:l,fetchCajas:a}=S(),[s,h]=x.useState(!1),[r,t]=x.useState(!1),[j,f]=x.useState(null),[p,C]=x.useState(!1),[g,N]=x.useState(null),[w,i]=x.useState(!1),[o,c]=x.useState(null),[d,b]=x.useState(null);x.useEffect(()=>{a()},[]);const O=async()=>{t(!1),await a()},$=u=>{f(u),C(!0)},Y=u=>{N(u),i(!0)},L=()=>{t(!0)},H=n?.data?.reduce((u,y)=>u+(y.total_ingresos||0),0)||0,P=n?.data?.reduce((u,y)=>u+(y.total_egresos||0),0)||0,R=n?.data?.reduce((u,y)=>u+(y.saldo_final||0),0)||0;return e.jsxs(B,{breadcrumbs:[{title:"Captaciones",href:route("captaciones.index")}],children:[e.jsxs("div",{className:"p-4",children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsx("h1",{className:"text-2xl font-bold",children:"Cajas"}),e.jsx(m,{onClick:L,variant:"outline",children:"Abrir Caja"})]}),e.jsxs("div",{className:"flex items-center space-x-2 mb-4",children:[e.jsx("label",{children:"Desde:"}),e.jsx("input",{type:"date",value:o||"",onChange:u=>c(u.target.value),className:"border rounded px-2 py-1"}),e.jsx("label",{children:"Hasta:"}),e.jsx("input",{type:"date",value:d||"",onChange:u=>b(u.target.value),className:"border rounded px-2 py-1"}),e.jsx(m,{onClick:()=>a({fechaInicio:o||void 0,fechaFin:d||void 0}),variant:"outline",children:"Filtrar"}),e.jsx(m,{onClick:()=>{c(null),b(null),a()},variant:"secondary",children:"Limpiar"})]}),e.jsxs("div",{className:"flex space-x-2 mb-4",children:[e.jsx(m,{variant:"outline",onClick:()=>window.open(route("cajas.export.pdf",{fechaInicio:o||"",fechaFin:d||""}),"_blank"),children:"Exportar PDF"}),e.jsx(m,{variant:"outline",onClick:()=>window.open(route("cajas.export.excel",{fechaInicio:o||"",fechaFin:d||""}),"_blank"),children:"Exportar Excel"})]}),e.jsx(X,{cajas:n.data,loading:l,refreshing:s,onCerrarCaja:$,onShowCaja:Y,totales:{totalIngresos:H,totalEgresos:P,totalSaldoFinal:R}}),e.jsx(Z,{currentPage:n?.current_page||1,lastPage:n?.last_page||1,onPageChange:u=>a({page:u,fechaInicio:o||void 0,fechaFin:d||void 0})})]}),e.jsx(K,{open:r,onClose:()=>t(!1),onSuccess:O}),e.jsx(Q,{open:p,onClose:()=>C(!1),caja:j,onSuccess:a}),e.jsx(W,{open:w,onClose:()=>i(!1),caja:g})]})};export{fe as Index,fe as default};
